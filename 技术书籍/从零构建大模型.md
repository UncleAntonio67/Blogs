---
tags:
  - æŠ€æœ¯ä¹¦ç±
aliases:
  - ä»é›¶æ„å»ºå¤§æ¨¡å‹
time: 20251213â€”â€”
author: Sebastian Raschka
website: https://skindhu.github.io/Build-A-Large-Language-Model-CN/
---
# ç›®å½•

ç¬¬1ç« â€”â€”ç†è§£å¤§é¢„è¨€æ¨¡å‹
ç¬¬2ç« â€”â€”å¤„ç†æ–‡æœ¬æ•°æ®
ç¬¬3ç« â€”â€”ç¼–ç æ³¨æ„åŠ›æœºåˆ¶
ç¬¬4ç« â€”â€”ä»å¤´å®ç°GPTæ¨¡å‹è¿›è¡Œæ–‡æœ¬ç”Ÿæˆ
ç¬¬5ç« â€”â€”åœ¨æ— æ ‡ç­¾æ•°æ®ä¸Šè¿›è¡Œé¢„è®­ç»ƒ
ç¬¬6ç« â€”â€”é’ˆå¯¹åˆ†ç±»çš„å¾®è°ƒ
ç¬¬7ç« â€”â€”é€šè¿‡å¾®è°ƒéµå¾ªäººç±»æŒ‡ä»¤

# ç¬¬1ç«  ç†è§£å¤§è¯­è¨€æ¨¡å‹

**æ·±åº¦å­¦ä¹ **æ˜¯**æœºå™¨å­¦ä¹ **å’Œ**äººå·¥æ™ºèƒ½**é¢†åŸŸçš„ä¸€ä¸ªé‡è¦åˆ†æ”¯ï¼Œä¸»è¦èšç„¦äºç¥ç»ç½‘ç»œçš„ç ”ç©¶ã€‚

åŸºäºTransformeræ¶æ„å¹¶åˆ©ç”¨æ•°æ®é›†æ¥è®­ç»ƒå¤§é¢„è¨€æ¨¡å‹çš„è½¬å˜ï¼Œå·²ç»ä»æ ¹æœ¬ä¸Šå˜é©äº†è‡ªç„¶è¯­è¨€å¤„ç†é¢†åŸŸï¼Œä¸ºæœºå™¨ç†è§£å¹¶ä¸ºäººç±»è¯­è¨€äº’åŠ¨æä¾›äº†æ›´å¼ºå¤§çš„å·¥å…·ã€‚

## 1.1 ä»€ä¹ˆæ˜¯å¤§è¯­è¨€æ¨¡å‹

å¤§è¯­è¨€æ¨¡å‹ï¼šç”¨äºç†è§£ã€ç”Ÿæˆå’Œå“åº”ç±»ä¼¼äººç±»è¯­è¨€æ–‡æœ¬å‘¢çš„ç¥ç»ç½‘ç»œã€‚

ä½¿ç”¨äº†Transformeræ¶æ„ï¼Œå…è®¸æ¨¡å‹åœ¨è¿›è¡Œé¢„æµ‹æ—¶æœ‰é€‰æ‹©çš„å…³æ³¨è¾“å…¥æ–‡æœ¬çš„ä¸åŒéƒ¨åˆ†ï¼Œä½¿å¾—ä»–ä»¬ç‰¹åˆ«æ“…é•¿åº”å¯¹äººç±»è¯­è¨€çš„ç»†å¾®å·®åˆ«å’Œå¤æ‚æ€§ã€‚

![[1765630747635.png | 300]]

## 1.2 å¤§è¯­è¨€æ¨¡å‹çš„åº”ç”¨

æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬ç”Ÿæˆã€æƒ…æ„Ÿåˆ†æã€æ–‡æœ¬æ‘˜è¦ç­‰ç­‰

| LLM               | å¤šæ¨¡æ…‹ | æ¨ç†  | å·¥å…·é‹ç”¨ |
| ----------------- | --- | --- | ---- |
| GPT-4o            | âœ…   | ğŸŸ¡  | âœ…    |
| Claude 4 Sonnet   | âœ…   | âœ…   | âœ…    |
| Grok 3            | âŒ   | âœ…   | âœ…    |
| o3                | âŒ   | âœ…   | âœ…    |
| Claude 4 Opus     | âœ…   | âœ…   | âœ…    |
| Gemini 2.5 Pro    | âœ…   | âœ…   | âœ…    |
| DeepSeek R1       | âŒ   | âœ…   | âœ…    |
| Gemma 3ï¼ˆ4Bï¼‰       | âŒ   | âŒ   | âŒ    |
| Mistral Small 3.1 | âœ…   | ğŸŸ¡  | ğŸŸ¡   |
| Qwen 3ï¼ˆ4Bï¼‰        | âŒ   | ğŸŸ¡  | âœ…    |
## 1.3 æ„å»ºå’Œä½¿ç”¨å¤§é¢„è¨€æ¨¡å‹çš„å„ä¸ªé˜¶æ®µ

å¤§è¯­è¨€æ¨¡å‹çš„æ„å»ºé€šå¸¸åŒ…æ‹¬é¢„è®­ç»ƒå’Œå¾®è°ƒï¼š
- é¢„è®­ç»ƒï¼šæ¨¡å‹çš„åˆå§‹é˜¶æ®µï¼Œæ¨¡å‹ä¼šåœ¨å¤§è§„æ¨¡ã€å¤šæ ·åŒ–çš„æ•°æ®é›†ä¸Šè®­ç»ƒï¼Œå½¢æˆå…¨é¢çš„è¯­è¨€ç†è§£èƒ½åŠ›ï¼ˆè‡ªç›‘ç£å­¦ä¹ ï¼‰
- å¾®è°ƒï¼šä»¥é¢„è®­ç»ƒä¸ºåŸºç¡€ï¼Œåœ¨ç‰¹å®šä»»åŠ¡ã€é¢†åŸŸè¿›è¡Œé’ˆå¯¹æ€§è®­ç»ƒã€‚

![[1765633485916.png | 400]]
å¾®è°ƒå¤§æ¨¡å‹æœ€æµè¡Œçš„æ–¹å¼ï¼š
- æŒ‡ä»¤å¾®è°ƒï¼šæ ‡æ³¨æ•°æ®é›†ç”±â€œæŒ‡ä»¤-ç­”æ¡ˆâ€å¯¹ç»„æˆ
- åˆ†ç±»å¾®è°ƒï¼šæ ‡æ³¨æ•°æ®é›†ç”±æ–‡æœ¬åŠå…¶ç±»åˆ«æ ‡ç­¾ç»„æˆ

## 1.4 Transformeræ¶æ„ä»‹ç»

è°·æ­Œ2017å¹´å‘å¸ƒè®ºæ–‡â€œAttention is All your Needâ€æå‡ºï¼ŒTransformeræœ€æ—©æ˜¯ä¸ºæœºå™¨ç¿»è¯‘ä»»åŠ¡å¼€å‘ã€‚

![[file-20251213215159224.png | 400]]

ä¸¤ä¸ªå­æ¨¡å—æ„æˆï¼š
- **ç¼–ç å™¨**ï¼šè´Ÿè´£å¤„ç†è¾“å…¥æ–‡æœ¬ï¼Œå°†å…¶ç¼–ç ä¸ºä¸€ç³»åˆ—æ•°å€¼è¡¨ç¤ºæˆ–è€…å‘é‡ï¼Œæ•æ‰è¾“å…¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯
- **è§£ç å™¨**ï¼šæ¥æ”¶è¿™äº›å‘é‡ï¼Œç”Ÿæˆè¾“å‡ºæ–‡æœ¬ã€‚

**æ³¨æ„åŠ›æœºåˆ¶**ï¼šå…è®¸æ¨¡å‹è¡¡é‡åºåˆ—ä¸­ä¸åŒå•è¯æˆ–è¯å…ƒä¹‹é—´çš„ç›¸å¯¹é‡è¦æ€§ï¼Œèƒ½ä½¿å¾—æ¨¡å‹æ•è·åˆ°è¾“å…¥æ•°æ®ä¸­é•¿è·ç¦»çš„ä¾èµ–å’Œä¸Šä¸‹æ–‡å…³ç³»ï¼Œæå‡ç”Ÿæˆè¿è´¯ä¸”ä¸Šä¸‹æ–‡ç›¸å…³çš„è¾“å‡ºçš„èƒ½åŠ›ã€‚

ä¸ºäº†é€‚åº”ä¸åŒç±»å‹çš„ä¸‹æ¸¸ï¼ŒTransformerç”±ä¸åŒçš„å˜ä½“ï¼š
- BERTï¼ˆBidirectional Encoder Representations from Transformerï¼‰ï¼šä¸“æ³¨äºæ©ç è®­ç»ƒï¼Œé¢„æµ‹ç»™å®šè·ç¦»è¢«æ©ç çš„è¯ã€‚ä¸»è¦ç”¨äºæƒ…æ„Ÿé¢„æµ‹ã€æ–‡æ¡£åˆ†ç±»
- GPTï¼ˆGenerative Pretrained Transformerï¼‰ï¼šä¸»è¦ç”¨äºå¤„ç†ç”Ÿæˆæ–‡æœ¬çš„ä»»åŠ¡ï¼ŒåŒ…æ‹¬æœºå™¨ç¿»è¯‘ã€æ–‡æœ¬æ‘˜è¦ã€å°è¯´åˆ›ä½œã€æ–‡æœ¬è¡¥å…¨ç­‰ç­‰ã€‚
## 1.5 åˆ©ç”¨å¤§å‹æ•°æ®é›†

GPT3çš„é¢„è®­ç»ƒæ•°æ®é›†ï¼š

|**æ•°æ®é›†**|**é¢„è®­ç»ƒæ•°æ®é‡ (Tokenæ•°é‡)**|**å æ€»æƒé‡ (Approx.)**|
|---|---|---|
|**CommonCrawl (è¿‡æ»¤å)**|çº¦ 4100 äº¿|60%|
|**WebText2**|çº¦ 190 äº¿|22%|
|**Books1 & Books2**|çº¦ 670 äº¿|16%|
|**Wikipedia**|çº¦ 30 äº¿|3%|
|**æ€»è®¡**|çº¦ 5000 äº¿|100%|
**è¯å…ƒ**ï¼ˆTokenï¼‰ï¼šçº¦ç­‰äºå•è¯å’Œæ ‡ç‚¹ç¬¦å·çš„æ•°é‡ã€‚

*è®­ç»ƒGPT-3çš„äº‘è®¡ç®—è´¹ç”¨æˆæœ¬é«˜è¾¾460ä¸‡ç¾å…ƒ

## 1.6 æ·±å…¥å‰–æGPTæ¶æ„

GPTçš„é€šç”¨æ¶æ„æ›´ä¸ºç®€æ´ï¼ŒåªåŒ…å«è§£ç å™¨ï¼Œå› ä¸ºå®ƒæ˜¯é€è¯é¢„æµ‹ï¼Œå› ä¸ºå®ƒè¢«è®¤ä¸ºæ˜¯ä¸€ç§**è‡ªå›å½’æ¨¡å‹**ï¼Œå°†ä¹‹å‰çš„è¾“å‡ºä½œä¸ºæœªæ¥é¢„æµ‹çš„è¾“å…¥ã€‚

*GPT-3çš„è§„æ¨¡è¿œè¶…Transformeræ¶æ„ã€‚åŸå§‹çš„Transformeræ¶æ„å°†ç¼–è§£ç å™¨é‡å¤6æ¬¡ï¼ŒGPT-3æ€»å…±æœ‰96å±‚Transformerå’Œ1750äº¿å‚æ•°ã€‚

æ¨¡å‹èƒ½å¤Ÿå®Œæˆæœªç»æ˜ç¡®è®­ç»ƒçš„ä»»åŠ¡çš„èƒ½åŠ›ç§°ä¸º**æ¶Œç°**ï¼Œå……åˆ†ä½“ç°äº†è¿™ç±»å¤§è§„æ¨¡ç”Ÿæˆå¼è¯­è¨€æ¨¡å‹çš„ä¼˜åŠ¿ã€‚

## 1.7 æ„å»ºå¤§è¯­è¨€æ¨¡å‹


![[file-20251213222512518.jpg]]

1. å­¦ä¹ æ•°æ®é¢„å¤„ç†ã€ç€æ‰‹å®ç°å¤§è¯­è¨€æ¨¡å‹çš„æ ¸å¿ƒç»„ä»¶â€”â€”æ³¨æ„åŠ›æœºåˆ¶
2. å­¦ä¹ å¦‚ä½•ç¼–å†™ä»£ç å¹¶é¢„è®­ç»ƒä¸€ä¸ªèƒ½å¤Ÿç”Ÿæˆæ–°æ–‡æœ¬çš„ç±»GPTæ¨¡å‹
3. è¿›è¡Œå¾®è°ƒï¼Œä½¿å…¶å›ç­”æŸ¥è¯¢ã€åˆ†ç±»ç­‰ä»»åŠ¡


# ç¬¬2ç«  å¤„ç†æ–‡æœ¬æ•°æ®

å¦‚ä½•ä¸ºå¤§æ¨¡å‹å‡†å¤‡è¾“å…¥æ–‡æœ¬ï¼Œå°†æ–‡æœ¬åˆ†å‰²ä¸ºç‹¬ç«‹çš„å•è¯è¯å…ƒå’Œå­è¯è¯å…ƒï¼Œé«˜çº§çš„åˆ†è¯æŠ€æœ¯BPEï¼Œå­—èŠ‚å¯¹ç¼–ç 

## 2.1 ç†è§£è¯åµŒå…¥

**åµŒå…¥**ï¼šæŠŠæ•°æ®è½¬æ¢ä¸ºå‘é‡æ ¼å¼ï¼Œä¸åŒçš„æ•°æ®éœ€è¦ä½¿ç”¨ä¸åŒçš„æ¨¡å‹åµŒå…¥ã€‚åµŒå…¥çš„æœ¬è´¨æ˜¯å°†ç¦»æ•£å¯¹è±¡ï¼ˆå¦‚å•è¯ã€å›¾åƒæˆ–æ•´ä¸ªæ–‡æ¡£ï¼‰æ˜ å°„åˆ°è¿ç»­å‘é‡ç©ºé—´ä¸­çš„ç‚¹ã€‚åµŒå…¥çš„ä¸»è¦ç›®çš„æ˜¯å°†éæ•°å€¼æ•°æ®è½¬æ¢ä¸ºç¥ç»ç½‘ç»œèƒ½å¤Ÿå¤„ç†çš„æ ¼å¼ã€‚

![[file-20251214220214060.png | 450]]

- è¯åµŒå…¥æœ€å¸¸è§ï¼ŒWord2Vecæ˜¯è¾ƒæ—©ä¸”æœ€å—æ¬¢è¿çš„é¡¹ç›®ä¹‹ä¸€ï¼Œæ ¸å¿ƒæ€æƒ³ï¼šå‡ºç°åœ¨ç›¸ä¼¼ä¸Šä¸‹æ–‡ä¸­çš„è¯é€šå¸¸å…·æœ‰ç›¸ä¼¼çš„å«ä¹‰
- å¥å­åµŒå…¥ã€æ®µè½åµŒå…¥åœ¨æ£€ç´¢å¢å¼ºç”Ÿæˆï¼ˆRAGï¼‰é¢†åŸŸéå¸¸æµè¡Œ

*è¯åµŒå…¥çš„ç»´åº¦è¶Šé«˜ï¼Œè¶Šæœ‰åŠ©äºæ•æ‰åˆ°æ›´ç»†å¾®çš„å…³ç³»ã€‚

å¤§é¢„è¨€æ¨¡å‹é€šè¿‡ä¼šè‡ªåŠ¨ç”ŸæˆåµŒå…¥ï¼ŒåµŒå…¥å¼æ˜¯è¾“å…¥å±‚çš„ä¸€éƒ¨åˆ†ï¼Œè¿™æ ·å¯ä»¥é’ˆå¯¹ç‰¹å®šçš„ä»»åŠ¡å’Œæ•°æ®è¿›è¡Œä¼˜åŒ–ã€‚

GPT-2çš„åµŒå…¥ç»´åº¦ï¼š768ï¼›GPT-3çš„åµŒå…¥ç»´åº¦ï¼š12288

## 2.2 ç†è§£è¯åµŒå…¥

æ–‡æœ¬åˆ†ä¸ºç‹¬ç«‹çš„è¯å…ƒï¼š

![[file-20251214221312852.png | 500]]

é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œåˆ†è¯ï¼š
![[file-20251214223151151.png]]

## 2.3 å°†è¯å…ƒè½¬æ¢ä¸ºè¯å…ƒID

æŠŠè¿™äº›è¯å…ƒä»å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•´æ•°è¡¨ç¤ºï¼Œç”Ÿæˆè¯å…ƒIDã€‚åµŒå…¥å‘é‡å‰çš„å¿…ç»æ­¥éª¤ã€‚

è¯å…ƒ-IDæ˜ å°„è¡¨ï¼š
![[file-20251214223459116.png]]
æ„å»ºè¯å…ƒã€IDäº’ç›¸æ„å»ºçš„æ–¹æ³•ï¼Œencodeï¼šå­—ç¬¦ä¸²â€”â€”>æ•´æ•°ä»¥åŠIDï¼Œdecodeï¼šæ•´æ•°â€”â€”>å­—ç¬¦ä¸²ã€‚

![[file-20251214223946209.png | 600]]

![[file-20251214224349338.png | 600]]

## 2.4 å¼•å…¥ç‰¹æ®Šä¸Šä¸‹æ–‡è¯å…ƒ

åœ¨é‡åˆ°è¯æ±‡è¡¨ä¸å­˜åœ¨çš„å•è¯æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ç‰¹æ®Šè¯å…ƒæ¥ä»£æ›¿ï¼Œå®ƒä¹Ÿä¼šæ’åœ¨ä¸ç›¸å…³çš„æ–‡æœ¬é—´ã€‚

![[file-20251215225742125.png | 600]]

å¸¸è§çš„ç‰¹æ®Šè¯å…ƒåŒ…æ‹¬ï¼š
- `[BOS]`ï¼šmarks the beginning of text
- `[EOS]`ï¼šmarks where the text ends
- `[UNK]`ï¼šÂ to represent words that are not included in the vocabulary
- `|endoftext|`Â tokens between two independent sources of text

- GPTæ¨¡å‹ä½¿ç”¨çš„åˆ†è¯å™¨ä¸ä¾èµ–è¿™äº›ç‰¹æ®Šçš„è¯å…ƒï¼Œä»…ä»…ä½¿ç”¨`|endoftext|`Â ç®€åŒ–å¤„ç†æµç¨‹
- GPTæ¨¡å‹çš„åˆ†è¯å™¨ä¹Ÿä¸é€‚ç”¨`[UNK]`æ¥å¤„ç†è¶…å‡ºèŒƒå›´çš„å•è¯ï¼Œè€Œæ˜¯ä½¿ç”¨BPEåˆ†è¯å™¨è¿›è¡Œæ‹†åˆ†

## 2.5 BPE

BPEåˆ†è¯å™¨ç”¨äºè®­ç»ƒå¤§è¯­è¨€æ¨¡å‹ï¼Œä½¿ç”¨å¼€æºåº“tiktokenã€‚

![[file-20251215231622871.png]]

ä¸¤ä¸ªè§‚å¯Ÿç»“æœï¼š
- `|endoftext|`è¢«åˆ†é…äº†ä¸€ä¸ªè¾ƒå¤§çš„è¯å…ƒï¼Œç”¨äºè®­ç»ƒGPTä¸­åŸå§‹æ¨¡å‹çš„è¯æ±‡æ€»é‡ä¸º50257ï¼Œå®ƒæ—¶æœ€å¤§çš„è¯å…ƒ
- BPEåˆ†è¯å™¨å¯ä»¥æ­£ç¡®çš„ç¼–ç å’Œè§£ç æœªçŸ¥çš„å•è¯ï¼ŒåŸç†æ˜¯å°†ä¸åœ¨é¢„å®šä¹‰çš„å•è¯åˆ†æä¸ºæ›´å°çš„å•è¯ç”šè‡³å•ä¸ªå­—ç¬¦ã€‚
![[file-20251215232131093.png | 500]]


## 2.6 ä½¿ç”¨æ»‘åŠ¨çª—å£è¿›è¡Œæ•°æ®é‡‡æ ·

ç”Ÿæˆç”¨äºæ¨¡å‹è®­ç»ƒçš„è¾“å…¥-ç›®æ ‡å¯¹

![[file-20251216210757780.png | 500]]
![[file-20251216211206063.png | 300]]

![[file-20251216211357418.png | 600]]

è¿™æ ·ï¼Œç”¨äºè®­ç»ƒçš„è¾“å…¥-ç›®æ ‡å¯¹å°±åˆ›å»ºå¥½äº†

åœ¨è½¬åŒ–ä¸ºåµŒå…¥å‘é‡å‰ï¼Œè¿˜éœ€è¦å®ç°ä¸€ä¸ªé«˜æ•ˆçš„æ•°æ®åŠ è½½å™¨ï¼šéå†è¾“å…¥æ•°æ®é›†ï¼Œå°†è¾“å…¥å’Œç›®æ ‡ä»¥å¼ é‡çš„å½¢å¼èŒƒå›´ã€‚å®é™…çš„ä»£ç ä¼šç›´æ¥æ“ä½œè¯å…ƒIDã€‚

![[file-20251216211705044.png]]


![[file-20251216212057234.png]]

ç»™äº†ä¸€ä¸ªDataloaderä¾‹å­ï¼Œä¸Šä¸‹æ–‡é•¿åº¦æ˜¯4ï¼Œä¸€èˆ¬å®é™…è®­ç»ƒè¿‡ç¨‹ä¸­æ˜¯ä¸å°äº256.
- strideå†³å®šçš„æ˜¯è¾“å…¥ä¹‹é—´çš„åç§»é‡ï¼Œå¯ä»¥å¢åŠ åˆ°4æ¥å……åˆ†åˆ©ç”¨æ•°æ®é›†ï¼Œé¿å…è¿‡æ‹Ÿåˆã€‚

![[file-20251216212422662.png | 600]]

## 2.7 åˆ›å»ºè¯å…ƒåµŒå…¥

å°†è¯å…ƒIDè½¬æ¢ä¸ºåµŒå…¥å‘é‡

![[file-20251216213014134.png | 500]]

ç±»GPTå¤§æ¨¡å‹ä½¿ç”¨åå‘ä¼ æ’­ç®—æ³•è®­ç»ƒçš„æ·±åº¦ç¥ç»ç½‘ç»œï¼Œå› æ­¤éœ€è¦è¿ç»­çš„å‘é‡è¡¨ç¤ºæˆ–åµŒå…¥ã€‚

è¯å…ƒåµŒå…¥å‘é‡çš„å·¥ä½œåŸç†ï¼š
- ä½¿ç”¨Â `vocab_size`Â å’ŒÂ `output_dim`åœ¨ PyTorch ä¸­å®ä¾‹åŒ–ä¸€ä¸ªåµŒå…¥å±‚ï¼Œå¹¶å°†éšæœºç§å­è®¾ç½®ä¸º 123
- æŸ¥çœ‹åµŒå…¥å±‚çš„åŸºç¡€æƒé‡çŸ©é˜µï¼Œæ¯ä¸€è¡Œä»£è¡¨è¯æ±‡è¡¨ä¸­çš„ä¸€ä¸ªtokenï¼ˆæ¯ä¸ªtokenéƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„å‘é‡è¡¨ç¤ºï¼‰ï¼Œè€Œæ¯ä¸€åˆ—ä»£è¡¨åµŒå…¥ç©ºé—´ä¸­çš„ä¸€ä¸ªç»´åº¦ï¼ˆåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒåµŒå…¥ç»´åº¦ä¸º3ï¼Œå³æ¯ä¸ªtokenè¢«è¡¨ç¤ºä¸ºä¸€ä¸ª3ç»´å‘é‡ï¼‰ã€‚
- åµŒå…¥å±‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæŸ¥æ‰¾åŠŸèƒ½ï¼Œé€šè¿‡token ID ä»åµŒå…¥å±‚çš„æƒé‡çŸ©é˜µä¸­æ£€ç´¢è¡Œã€‚

![[file-20251216214250705.png]]

**åº”ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œå°†è¯å…ƒè½¬ä¸ºåµŒå…¥å‘é‡ï¼Œå°±æ˜¯ä»åµŒå…¥æƒé‡çŸ©é˜µä¸­æŸ¥æ‰¾å¾—æ¥çš„ã€‚**

![[file-20251216214724625.png]]
## 2.8 ç¼–ç å•è¯ä½ç½®ä¿¡æ¯

åµŒå…¥å‘é‡è¿˜ä¸èƒ½ç›´æ¥ä½œä¸ºå¤§æ¨¡å‹çš„è¾“å…¥ï¼Œå¤§æ¨¡å‹çš„ä¸€ä¸ªç¼ºé™·å°±æ˜¯å®ƒä»¬çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æ— æ³•æ„ŸçŸ¥è¯å…ƒåœ¨åºåˆ—ä¸­çš„ä½ç½®æˆ–é¡ºåºï¼Œæ‰€ä»¥éœ€è¦å‘å¤§æ¨¡å‹æ³¨å…¥é¢å¤–çš„ä½ç½®ä¿¡æ¯ã€‚

![[file-20251216215612565.png | 500]]

å¯ä»¥é‡‡ç”¨ä¸¤ç§ä½ç½®ä¿¡æ¯åµŒå…¥ç­–ç•¥ï¼š
- **ç»å¯¹ä½ç½®åµŒå…¥**ï¼šç»å¯¹ä½ç½®åµŒå…¥ä¸åºåˆ—ä¸­çš„ç‰¹å®šä½ç½®ç›´æ¥ç›¸å…³ã€‚å¯¹äºè¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®ï¼Œéƒ½ä¼šå°†ä¸€ä¸ªå”¯ä¸€çš„ç»å¯¹ä½ç½®åµŒå…¥å‘é‡æ·»åŠ åˆ°tokençš„åµŒå…¥å‘é‡ä¸­ï¼Œä»¥ä¼ è¾¾å…¶ç¡®åˆ‡ä½ç½®
- **ç›¸å¯¹ä½ç½®åµŒå…¥**ï¼šå¼ºè°ƒçš„æ˜¯tokenä¹‹é—´çš„ç›¸å¯¹ä½ç½®æˆ–è·ç¦»ã€‚è¿™æ„å‘³ç€æ¨¡å‹å­¦ä¹ çš„æ˜¯â€œç›¸éš”å¤šè¿œâ€çš„å…³ç³»ï¼Œè€Œä¸æ˜¯â€œåœ¨ä»€ä¹ˆç¡®åˆ‡ä½ç½®â€ã€‚è¿™æ ·çš„ä¼˜åŠ¿åœ¨äºï¼Œå³ä½¿æ¨¡å‹åœ¨è®­ç»ƒæ—¶æ²¡æœ‰æ¥è§¦è¿‡ä¸åŒçš„é•¿åº¦ï¼Œå®ƒä¹Ÿå¯ä»¥æ›´å¥½åœ°é€‚åº”å„ç§é•¿åº¦çš„åºåˆ—ã€‚

![[file-20251216220031924.png | 600]]

OpenAI çš„ GPT æ¨¡å‹ä½¿ç”¨ç»å¯¹ä½ç½®åµŒå…¥ï¼Œè¿™äº›åµŒå…¥åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è¿›è¡Œä¼˜åŒ–ã€‚

- ä½¿ç”¨ä¸€ä¸ª258ç»´ï¼Œè¯æ±‡é‡ä¸º50257çš„åµŒå…¥å±‚è¿›è¡Œè¯å…ƒåµŒå…¥ã€‚
- å¼€å§‹ç»å¯¹ä½ç½®åµŒå…¥ï¼Œåˆ›å»ºä¸€ä¸ªç»´åº¦ç›¸åŒçš„åµŒå…¥å±‚
- ç„¶åç›´æ¥æ·»åŠ ä¸Šå»ï¼Œè¿™æ ·å°±ç”Ÿæˆäº†å¤§è¯­è¨€æ¨¡å‹æ ¸å¿ƒæ¨¡å—å¯ä»¥å¤„ç†çš„åµŒå…¥è¾“å…¥å®ä¾‹ã€‚

![[file-20251216220943280.png | 400]]


> [!Question]
> **â“åå‘ä¼ æ’­ç®—æ³•éœ€æ±‚è¿ç»­çš„å‘é‡è¡¨ç¤ºæˆ–åµŒå…¥ï¼Ÿ**
> LLMä½¿ç”¨çš„Transformeræ¶æ„ï¼Œæœ¬è´¨ä¸Šæ˜¯è®¾è®¡ç”¨æ¥å¤„ç†**è¿ç»­çš„ã€æ•°å€¼åŒ–çš„æ•°æ®**ï¼ˆå³æµ®ç‚¹æ•°çš„å¼ é‡ï¼‰
> - Embeddingå±‚å°†æ¯ä¸ªç¦»æ•£çš„IDæ˜ å°„åˆ°ä¸€ä¸ª**ç¨ å¯†çš„ã€è¿ç»­çš„å®æ•°å‘é‡**ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ª $768$ ç»´çš„å‘é‡ï¼‰ã€‚è¿™ç§è¿ç»­æ€§ä½¿å¾—å‘é‡å¯¹äºæŸå¤±å‡½æ•°æ˜¯**å¯å¾®åˆ†çš„**ï¼Œè¿™æ˜¯ä½¿ç”¨åå‘ä¼ æ’­ç®—æ³•ï¼ˆBackpropagationï¼‰è¿›è¡Œè®­ç»ƒå’Œä¼˜åŒ–çš„**å…ˆå†³æ¡ä»¶**ã€‚
> - Embeddingæ˜¯ä¸€ç§â€œåˆ†å¸ƒå¼è¡¨ç¤ºâ€ï¼ˆDistributed Representationï¼‰ã€‚å®ƒä¸æ˜¯ç”¨ä¸€ä¸ªå•ä¸€çš„ç»´åº¦ä»£è¡¨ä¸€ä¸ªè¯çš„å…¨éƒ¨æ„ä¹‰ï¼Œè€Œæ˜¯å°†è¯çš„æ„ä¹‰åˆ†æ•£å­˜å‚¨åœ¨å‘é‡çš„**æ‰€æœ‰ç»´åº¦**ä¸Šã€‚

> [!Question]
> **â“åµŒå…¥å±‚çš„æ„å»ºè¿‡ç¨‹ï¼ŒåµŒå…¥æƒé‡çš„ç”Ÿæˆï¼Ÿ**
> éšæœºåˆå§‹åŒ–æ˜¯ä¸ºäº†**æ‰“ç ´å¯¹ç§°æ€§**ã€‚å¦‚æœæ‰€æœ‰çš„è¯æ±‡éƒ½ä»åŒä¸€ä¸ªå‘é‡å¼€å§‹ï¼Œé‚£ä¹ˆåœ¨åå‘ä¼ æ’­ä¸­ï¼Œå®ƒä»¬å°†æ€»æ˜¯ä»¥ç›¸åŒçš„æ–¹å¼æ›´æ–°ï¼Œæ¨¡å‹å°†æ— æ³•åŒºåˆ†å®ƒä»¬ã€‚ åœ¨è¿™ä¸€åˆ»ï¼Œè¿™äº›å‘é‡**ä¸åŒ…å«ä»»ä½•è¯­ä¹‰ä¿¡æ¯**ã€‚è¯æ±‡ $0$ å’Œè¯æ±‡ $5$ çš„å‘é‡åœ¨ç©ºé—´ä¸­çš„è·ç¦»æ˜¯éšæœºçš„ï¼Œä¸èƒ½ä»£è¡¨å®ƒä»¬çš„ç›¸ä¼¼æ€§ã€‚
> - **ä¼˜åŒ–**ï¼šEmbedding å‘é‡æ˜¯æ·±åº¦ç¥ç»ç½‘ç»œä¸­**å¯å­¦ä¹ çš„å‚æ•°**
> - **è®­ç»ƒç›®æ ‡ï¼š** æ¨¡å‹ï¼ˆå¦‚GPTï¼‰çš„ç›®æ ‡æ˜¯æœ€å¤§åŒ–é¢„æµ‹ä¸‹ä¸€ä¸ªè¯çš„æ¦‚ç‡ï¼Œæˆ–è€…æœ€å°åŒ–å…¶æŸå¤±å‡½æ•°ï¼ˆLossï¼‰ã€‚
> - **æ¢¯åº¦æµï¼š** å½“æ¨¡å‹çŠ¯é”™æ—¶ï¼ˆä¾‹å¦‚ï¼Œé¢„æµ‹â€œçŒ«â€æ˜¯â€œé¦™è•‰â€ï¼‰ï¼ŒæŸå¤±å‡½æ•°ä¼šè®¡ç®—è¯¯å·®ã€‚è¿™ä¸ªè¯¯å·®ä¼šé€šè¿‡**åå‘ä¼ æ’­**ç®—æ³•ï¼Œä»¥æ¢¯åº¦çš„å½¢å¼æµè¿‡æ•´ä¸ªç½‘ç»œï¼Œæœ€ç»ˆæµå› Embedding å±‚ã€‚
> - **æƒé‡æ›´æ–°ï¼š** æ¢¯åº¦å‘Šè¯‰ä¼˜åŒ–å™¨ï¼ˆå¦‚Adamï¼‰ï¼šâ€œä¸ºäº†å‡å°‘è¿™ä¸ªé”™è¯¯ï¼Œä½ åº”è¯¥å¾€å“ªä¸ªæ–¹å‘å¾®è°ƒâ€˜çŒ«â€™å’Œâ€˜é¦™è•‰â€™çš„å‘é‡ï¼Ÿâ€ ä¼˜åŒ–å™¨å°±ä¼šæŒ‰ç…§æ¢¯åº¦æ–¹å‘**æ›´æ–°**è¿™äº›éšæœºåˆå§‹åŒ–çš„å‘é‡ã€‚


> [!Question]
> **â“ç»å¯¹ä½ç½®å¢åŠ çš„åµŒå…¥å±‚ï¼Ÿ**
> åŠ æ³•ç¡®ä¿äº†**è¯åµŒå…¥**å’Œ**å¯¹åº”ä½ç½®ç¼–ç **çš„ç²¾ç¡®é…å¯¹ã€‚
> - **è¯å…ƒ A**ï¼ˆåœ¨ä½ç½® 0ï¼‰ï¼š$\text{Token}_A + \text{PE}_0$
> - **è¯å…ƒ B**ï¼ˆåœ¨ä½ç½® 1ï¼‰ï¼š$\text{Token}_B + \text{PE}_1$
> - **è¯å…ƒ C**ï¼ˆåœ¨ä½ç½® 2ï¼‰ï¼š$\text{Token}_C + \text{PE}_2$


# 3 ç¼–ç æ³¨æ„åŠ›æœºåˆ¶

å‰é¢çš„ç« èŠ‚å·²ç»å‘Šè¯‰æˆ‘ä»¬å¦‚ä½•å°†æ–‡æœ¬åˆ†å‰²æˆå•è¯ï¼Œå°†è¯å…ƒç¼–ç æˆå‘é‡è¡¨ç¤ºã€‚

æœ¬ç« æ¢è®¨æ³¨æ„åŠ›æœºåˆ¶ã€‚

![[1766064684785.png]]
ä¸Šå›¾ç»™å‡ºäº†4ç§æ³¨æ„åŠ›æœºåˆ¶çš„å˜ä½“ã€‚

## 3.1 é•¿åºåˆ—å»ºæ¨¡ä¸­çš„é—®é¢˜

æ–‡æœ¬ç¿»è¯‘æ—¶ä¸èƒ½é€è¯ç¿»è¯‘ï¼Œæºå’Œç›®æ ‡è¯­è¨€çš„è¯­æ³•ç»“æ„ä¸åŒã€‚

![[file-20251218213326053.png | 600]]

ä¸ºäº†è§£å†³é€è¯ç¿»è¯‘çš„å±€é™æ€§ï¼Œé€šå¸¸ä½¿ç”¨åŒ…å«ä¸¤ä¸ªå­æ¨¡å—çš„æ·±åº¦ç¥ç»ç½‘ç»œï¼Œå³æ‰€è°“çš„ç¼–ç å™¨ï¼ˆencoderï¼‰å’Œè§£ç å™¨ï¼ˆdecoderï¼‰ã€‚ç¼–ç å™¨çš„ä»»åŠ¡æ˜¯å…ˆè¯»å–å¹¶å¤„ç†æ•´ä¸ªæ–‡æœ¬ï¼Œç„¶åè§£ç å™¨ç”Ÿæˆç¿»è¯‘åçš„æ–‡æœ¬ã€‚

Transformerå‡ºç°å‰ï¼Œæœ€æµè¡Œçš„ç”¨äºè¯­è¨€ç¿»è¯‘çš„ç¼–ç å™¨-è§£ç å™¨æ¶æ„æ˜¯RNNã€‚

**RNNï¼š** å°†å‰ä¸€æ­¥çš„è¾“å‡ºä½œä¸ºå½“å‰çš„è¾“å…¥ï¼Œé€‚åˆå¤„ç†æ–‡æœ¬åºåˆ—æ•°æ®ã€‚è¾“å…¥æ–‡æœ¬è¢«è¾“å…¥åˆ°ç¼–ç å™¨ä¸­ï¼Œç¼–ç å™¨æŒ‰é¡ºåºå¤„ç†æ–‡æœ¬å†…å®¹ã€‚åœ¨æ¯ä¸ªæ­¥éª¤ä¸­ï¼Œç¼–ç å™¨ä¼šæ›´æ–°å…¶éšçŠ¶æ€ï¼ˆå³éšè—å±‚çš„å†…éƒ¨å€¼ï¼‰ï¼Œè¯•å›¾åœ¨æœ€ç»ˆçš„éšçŠ¶æ€ä¸­æ•æ‰æ•´ä¸ªè¾“å…¥å¥å­çš„å«ä¹‰ã€‚

![[file-20251218213716380.png | 600]]

ç¼–ç å™¨éƒ¨åˆ†å°†æ•´ä¸ªè¾“å…¥æ–‡æœ¬å¤„ç†ä¸ºä¸€ä¸ªéšè—çŠ¶æ€ï¼ˆè®°å¿†å•å…ƒï¼‰ã€‚è§£ç å™¨éšåä½¿ç”¨è¯¥éšè—çŠ¶æ€ç”Ÿæˆè¾“å‡ºã€‚æ‚¨å¯ä»¥å°†è¿™ä¸ªéšè—çŠ¶æ€è§†ä¸ºä¸€ä¸ªåµŒå…¥å‘é‡ã€‚

**ç¼ºç‚¹**ï¼šRNNæ— æ³•ç›´æ¥è®¿é—®ç¼–ç å™¨ä¸­çš„æ—©æœŸéšè—çŠ¶æ€ï¼Œåªèƒ½ä¾èµ–å½“å‰çš„éšè—çŠ¶æ€ã€‚åœ¨ä¾èµ–å…³ç³»è¾ƒé•¿çš„å¤æ‚å¥å­ä¸­ï¼Œä¼šå¯¼è‡´ä¸Šä¸‹æ–‡ä¿¡æ¯çš„ä¸¢å¤±ã€‚

ç¼–ç å™¨-è§£ç å™¨ RNN å­˜åœ¨ä¸€ä¸ªç¼ºç‚¹ï¼Œè¿™ä¸€ç¼ºç‚¹ä¿ƒä½¿äº†æ³¨æ„åŠ›æœºåˆ¶çš„è®¾è®¡ã€‚

## 3.2 é€šè¿‡æ³¨æ„åŠ›æœºåˆ¶æ•æ‰æ•°æ®ä¾èµ–å…³ç³»

ç ”ç©¶äººå‘˜åœ¨ 2014 å¹´ä¸º RNN å¼€å‘äº†æ‰€è°“çš„ Bahdanau æ³¨æ„åŠ›æœºåˆ¶ã€‚è¯¥æœºåˆ¶å¯¹ç¼–ç å™¨-è§£ç å™¨æ¶æ„çš„ RNN è¿›è¡Œäº†æ”¹è¿›ï¼Œä½¿å¾—è§£ç å™¨åœ¨æ¯ä¸ªè§£ç æ­¥éª¤å¯ä»¥é€‰æ‹©æ€§åœ°è®¿é—®è¾“å…¥åºåˆ—çš„ä¸åŒéƒ¨åˆ†ã€‚

![[file-20251218214331599.png | 600]]

ä¸‰å¹´åï¼Œç ”ç©¶äººå‘˜å‘ç°æ„å»ºç”¨äºè‡ªç„¶è¯­è¨€å¤„ç†çš„æ·±åº¦ç¥ç»ç½‘ç»œå¹¶ä¸éœ€è¦ RNN ç»“æ„ï¼Œéšåæå‡ºäº†åŸºäºè‡ªæ³¨æ„åŠ›æœºåˆ¶çš„åŸå§‹ Transformer æ¶æ„ï¼Œå…¶çµæ„Ÿæ¥è‡ª Bahdanau æå‡ºçš„æ³¨æ„åŠ›æœºåˆ¶ã€‚

è‡ªæ³¨æ„åŠ›æœºåˆ¶å…è®¸è¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªä½ç½®åœ¨è®¡ç®—åºåˆ—è¡¨ç¤ºæ—¶å…³æ³¨åŒä¸€åºåˆ—ä¸­æ‰€æœ‰ä½ç½®çš„æœºåˆ¶ã€‚è‡ªæ³¨æ„åŠ›æœºåˆ¶æ˜¯åŸºäºTransformeræ¶æ„çš„å½“ä»£å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚GPTç³»åˆ—æ¨¡å‹ï¼‰çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚

æœ¬ç« å°†é‡ç‚¹è®²è§£å¹¶å®ç° GPT ç±»æ¨¡å‹ä¸­ä½¿ç”¨çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€‚

![[1766065589484.png | 400]]

## 3.3 é€šè¿‡è‡ªæ³¨æ„åŠ›æœºåˆ¶å…³æ³¨è¾“å…¥çš„ä¸åŒéƒ¨åˆ†

**è‡ªæ³¨æ„åŠ›æœºåˆ¶**ï¼š â€œselfâ€æŒ‡çš„æ˜¯è¯¥æœºåˆ¶é€šè¿‡å…³è”åŒä¸€è¾“å…¥åºåˆ—ä¸­çš„ä¸åŒä½ç½®æ¥è®¡ç®—æ³¨æ„åŠ›æƒé‡çš„èƒ½åŠ›ã€‚å®ƒè¯„ä¼°å¹¶å­¦ä¹ è¾“å…¥å†…éƒ¨å„éƒ¨åˆ†ä¹‹é—´çš„å…³ç³»å’Œä¾èµ–æ€§ï¼Œä¾‹å¦‚å¥å­ä¸­çš„å•è¯æˆ–å›¾åƒä¸­çš„åƒç´ ã€‚
**æ³¨æ„åŠ›æœºåˆ¶**ï¼šå…³æ³¨çš„æ˜¯ä¸¤ä¸ªä¸åŒåºåˆ—é—´çš„å…³ç³»ï¼Œä¾‹å¦‚åºåˆ—åˆ°åºåˆ—æ¨¡å‹ä¸­ï¼Œæ³¨æ„åŠ›å¯èƒ½å­˜åœ¨äºè¾“å…¥åºåˆ—å’Œè¾“å‡ºåºåˆ—ä¹‹é—´ã€‚

### 3.3.1 ä¸€ç§ä¸å«å¯è®­ç»ƒæƒé‡çš„ç®€åŒ–è‡ªæ³¨æ„åŠ›æœºåˆ¶

![[1766066370769(1).png | 500]]
- ä¸€ä¸ªè¾“å…¥åºåˆ—ï¼Œè®°ä½œ xï¼Œç”± T ä¸ªå…ƒç´ ç»„æˆï¼Œè¡¨ç¤ºä¸º x(1)Â åˆ° x(T)ã€‚è¯¥åºåˆ—é€šå¸¸ä»£è¡¨æ–‡æœ¬ï¼Œä¾‹å¦‚ä¸€ä¸ªå¥å­ï¼Œå¹¶ä¸”è¯¥æ–‡æœ¬å·²è¢«è½¬æ¢ä¸º token åµŒå…¥ã€‚
- åœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œç›®æ ‡æ˜¯ä¸ºè¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´  x(i)Â è®¡ç®—å…¶å¯¹åº”çš„ä¸Šä¸‹æ–‡å‘é‡ z(i)Â ã€‚ä¸Šä¸‹æ–‡å‘é‡å¯ä»¥è¢«è§£é‡Šä¸ºä¸€ç§å¢å¼ºçš„åµŒå…¥å‘é‡ï¼Œå®ƒä»¬çš„ç›®çš„æ˜¯é€šè¿‡æ•´åˆåºåˆ—ä¸­æ‰€æœ‰å…¶ä»–å…ƒç´ çš„ä¿¡æ¯ï¼ˆå¦‚åŒä¸€ä¸ªå¥å­ä¸­çš„å…¶ä»–è¯ï¼‰ï¼Œä¸ºè¾“å…¥åºåˆ—ä¸­çš„æ¯ä¸ªå…ƒç´ åˆ›å»ºä¸°å¯Œçš„è¡¨ç¤ºã€‚è¿™å¯¹å¤§è¯­è¨€æ¨¡å‹è‡³å…³é‡è¦ï¼Œå› ä¸ºæ¨¡å‹éœ€è¦ç†è§£å¥å­ä¸­å„ä¸ªè¯ä¹‹é—´çš„å…³ç³»å’Œå…³è”æ€§ã€‚

å®ç°è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„ç¬¬ä¸€æ­¥æ˜¯è®¡ç®—ä¸­é—´å€¼Â **Ï‰**ï¼Œå³æ³¨æ„åŠ›å¾—åˆ†ï¼š
è®¡ç®—æ–¹å¼ï¼šé€šè¿‡è®¡ç®—æŸ¥è¯¢ x(2)Â ä¸æ¯ä¸ªå…¶ä»–è¾“å…¥ token çš„ç‚¹ç§¯æ¥ç¡®å®šè¿™äº›å¾—åˆ†ã€‚
è¾ƒé«˜çš„ç‚¹ç§¯å€¼è¡¨ç¤ºå‘é‡ä¹‹é—´æœ‰æ›´é«˜çš„å¯¹é½ç¨‹åº¦æˆ–ç›¸ä¼¼åº¦ã€‚åœ¨è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„èƒŒæ™¯ä¸‹ï¼Œç‚¹ç§¯å†³å®šäº†åºåˆ—ä¸­å…ƒç´ ä¹‹é—´çš„å…³æ³¨ç¨‹åº¦ï¼šç‚¹ç§¯å€¼è¶Šé«˜ï¼Œä¸¤ä¸ªå…ƒç´ ä¹‹é—´çš„ç›¸ä¼¼åº¦å’Œæ³¨æ„åŠ›å¾—åˆ†å°±è¶Šé«˜ã€‚


> [!NOTE]
> å®é™…ä¸Šï¼Œæ¯ä¸ªè¾“å…¥Tokenä¼šå…ˆé€šè¿‡æƒé‡çŸ©é˜µWåˆ†åˆ«è®¡ç®—å‡ºå®ƒçš„Qã€Kã€Vä¸‰ä¸ªå‘é‡ï¼Œé’ˆå¯¹æ¯ä¸€ä¸ªç›®æ ‡tokenï¼ŒTransformerä¼šè®¡ç®—å®ƒçš„Â `Qå‘é‡`Â ä¸å…¶å®ƒæ‰€æœ‰çš„tokençš„Â `Kå‘é‡`Â çš„ç‚¹ç§¯ï¼Œä»¥ç¡®å®šæ¯ä¸ªè¯å¯¹å½“å‰è¯çš„é‡è¦æ€§.


![[file-20251218220442628.png]]
å¯¹äºæ³¨æ„åŠ›åˆ†æ•°è¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼Œå½’ä¸€åŒ–çš„ä¸»è¦ç›®çš„æ˜¯ä½¿æ³¨æ„åŠ›æƒé‡ä¹‹å’Œä¸º 1ã€‚è¿™ç§å½’ä¸€åŒ–æ˜¯ä¸€ç§æœ‰åŠ©äºè§£é‡Šå’Œä¿æŒLLMè®­ç»ƒç¨³å®šæ€§çš„æƒ¯ä¾‹ï¼š

![[file-20251218221920895.png]]
ä½¿ç”¨ softmax å‡½æ•°æ¥è¿›è¡Œå½’ä¸€åŒ–ï¼Œæ›´æ“…é•¿å¤„ç†æç«¯å€¼ï¼Œå¹¶ä¸”åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æä¾›äº†æ›´æœ‰åˆ©çš„æ¢¯åº¦ç‰¹æ€§ã€‚softmax å‡½æ•°ç¡®ä¿æ³¨æ„åŠ›æƒé‡å§‹ç»ˆä¸ºæ­£å€¼ã€‚è¿™ä½¿å¾—è¾“å‡ºå¯ä»¥è¢«è§£é‡Šä¸ºæ¦‚ç‡æˆ–ç›¸å¯¹é‡è¦æ€§ï¼Œå…¶ä¸­è¾ƒé«˜çš„æƒé‡è¡¨ç¤ºæ›´é‡è¦ã€‚

![[file-20251218222153932.png]]

è¿™ç§ç®€å•çš„ softmax å®ç°ï¼ˆsoftmax_naiveï¼‰åœ¨å¤„ç†è¾ƒå¤§æˆ–è¾ƒå°çš„è¾“å…¥å€¼æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°æ•°å€¼ä¸ç¨³å®šæ€§é—®é¢˜ï¼Œä¾‹å¦‚ä¸Šæº¢æˆ–ä¸‹æº¢ã€‚å› æ­¤ï¼Œå®é™…æ“ä½œä¸­ï¼Œå»ºè®®ä½¿ç”¨ PyTorch çš„ softmax å®ç°ï¼Œå®ƒç»è¿‡äº†å……åˆ†çš„æ€§èƒ½ä¼˜åŒ–ï¼š

![[file-20251218222259277.png]]

> [!NOTE]
> `Softmax`, å®ƒæ˜¯ä¸€ç§å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œå°¤å…¶åœ¨ç¥ç»ç½‘ç»œçš„åˆ†ç±»ä»»åŠ¡ä¸­è¢«å¹¿æ³›ä½¿ç”¨ã€‚å®ƒçš„ä½œç”¨æ˜¯å°†ä¸€ä¸ªä»»æ„çš„å®æ•°å‘é‡è½¬æ¢ä¸ºä¸€ä¸ªæ¦‚ç‡åˆ†å¸ƒï¼Œä¸”æ‰€æœ‰å…ƒç´ çš„æ¦‚ç‡ä¹‹å’Œä¸º 1ã€‚
> åœ¨ç¥ç»ç½‘ç»œä¸­ï¼Œç‰¹åˆ«æ˜¯åˆ†ç±»æ¨¡å‹ï¼ˆå¦‚å›¾åƒåˆ†ç±»ã€æ–‡æœ¬åˆ†ç±»ï¼‰ä¸­ï¼ŒSoftmax å±‚é€šå¸¸ç”¨ä½œæœ€åä¸€å±‚è¾“å‡ºã€‚


æœ€åä¸€æ­¥ï¼šé€šè¿‡å°†åµŒå…¥åçš„è¾“å…¥ token x(i)Â ä¸ç›¸åº”çš„æ³¨æ„åŠ›æƒé‡ç›¸ä¹˜ï¼Œå†å°†æ‰€å¾—å‘é‡æ±‚å’Œæ¥è®¡ç®—ä¸Šä¸‹æ–‡å‘é‡ z(2)ã€‚
åœ¨è®¡ç®—å¹¶å½’ä¸€åŒ–æ³¨æ„åŠ›åˆ†æ•°ä»¥è·å–æŸ¥è¯¢x(2)çš„æ³¨æ„åŠ›æƒé‡åï¼Œè®¡ç®—ä¸Šä¸‹æ–‡å‘é‡ã€‚

![[file-20251218224406980.png]]

### 3.3.2 ä¸ºæ‰€æœ‰è¾“å…¥çš„ token è®¡ç®—æ³¨æ„åŠ›æƒé‡

ä¸Šä¸€èŠ‚ï¼Œè®¡ç®—äº†ç¬¬äºŒä¸ªè¾“å…¥å…ƒç´ çš„æ³¨æ„åŠ›æƒé‡å’Œä¸Šä¸‹æ–‡å‘é‡ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å°†æ‰©å±•è¯¥è®¡ç®—ï¼Œä»¥å¯¹æ‰€æœ‰è¾“å…¥è®¡ç®—æ³¨æ„åŠ›æƒé‡å’Œä¸Šä¸‹æ–‡å‘é‡ã€‚

![[file-20251218224906490.png | 500]]
![[file-20251218224944399.png | 400]]

åœ¨ä½¿ç”¨ PyTorch æ—¶ï¼ŒåƒÂ `torch.softmax`Â è¿™æ ·çš„å‡½æ•°ä¸­çš„Â `dim`Â å‚æ•°æŒ‡å®šäº†å°†åœ¨è¾“å…¥å¼ é‡ä¸­çš„å“ªä¸ªç»´åº¦ä¸Šè¿›è¡Œå½’ä¸€åŒ–è®¡ç®—ã€‚é€šè¿‡è®¾ç½®Â `dim=-1`ï¼Œæˆ‘ä»¬æŒ‡ç¤ºÂ `softmax`Â å‡½æ•°æ²¿ç€Â `attn_scores`Â å¼ é‡çš„æœ€åä¸€ä¸ªç»´åº¦è¿›è¡Œå½’ä¸€åŒ–æ“ä½œã€‚å¦‚æœÂ `attn_scores`Â æ˜¯ä¸€ä¸ªäºŒç»´å¼ é‡ï¼ˆä¾‹å¦‚ï¼Œå½¢çŠ¶ä¸ºÂ `[è¡Œæ•°, åˆ—æ•°]`ï¼‰ï¼Œåˆ™Â `dim=-1`Â å°†æ²¿åˆ—æ–¹å‘è¿›è¡Œå½’ä¸€åŒ–ï¼Œä½¿å¾—æ¯ä¸€è¡Œçš„å€¼ï¼ˆæ²¿åˆ—æ–¹å‘æ±‚å’Œï¼‰ä¹‹å’Œç­‰äº 1ã€‚

![[file-20251218230114079.png ]]
ç”¨è¿™äº›æ³¨æ„åŠ›æƒé‡é€šè¿‡çŸ©é˜µä¹˜æ³•è®¡ç®—æ‰€æœ‰çš„ä¸Šä¸‹æ–‡å‘é‡ã€‚

![[file-20251218230730191.png]]

## 3.4  å®ç°å¸¦æœ‰å¯è®­ç»ƒæƒé‡çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶

æ¥ä¸‹æ¥å®ç°ä¸€ç§åœ¨åŸå§‹ Transformer æ¶æ„ã€GPT æ¨¡å‹ä»¥åŠå¤§å¤šæ•°å…¶ä»–æµè¡Œçš„å¤§è¯­è¨€æ¨¡å‹ä¸­ä½¿ç”¨çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€‚è¿™ç§è‡ªæ³¨æ„åŠ›æœºåˆ¶ä¹Ÿè¢«ç§°ä¸º**ç¼©æ”¾ç‚¹ç§¯æ³¨æ„åŠ›**ã€‚
![[file-20251218231312741.png]]

å¸¦æœ‰å¯è®­ç»ƒæƒé‡çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶æ˜¯åŸºäºä¹‹å‰ç®€åŒ–è‡ªæ³¨æ„åŠ›æœºåˆ¶çš„æ”¹è¿›ï¼šæˆ‘ä»¬å¸Œæœ›è®¡ç®—æŸä¸ªç‰¹å®šè¾“å…¥å…ƒç´ çš„åµŒå…¥å‘é‡çš„åŠ æƒå’Œæ¥ä½œä¸ºä¸Šä¸‹æ–‡å‘é‡ã€‚

æœ€æ˜¾è‘—çš„åŒºåˆ«åœ¨äºå¼•å…¥äº†åœ¨æ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­ä¸æ–­æ›´æ–°çš„æƒé‡çŸ©é˜µã€‚è¿™äº›å¯è®­ç»ƒçš„æƒé‡çŸ©é˜µè‡³å…³é‡è¦ï¼Œå®ƒä»¬ä½¿æ¨¡å‹ï¼ˆç‰¹åˆ«æ˜¯æ¨¡å‹å†…éƒ¨çš„æ³¨æ„åŠ›æ¨¡å—ï¼‰èƒ½å¤Ÿå­¦ä¹ ç”Ÿæˆâ€œä¼˜è´¨â€çš„ä¸Šä¸‹æ–‡å‘é‡ã€‚

### 3.4.1 é€æ­¥è®¡ç®—æ³¨æ„åŠ›æƒé‡

é€šè¿‡å¼•å…¥3ä¸ªå¯è®­ç»ƒçš„æƒé‡çŸ©é˜µWqã€WkÂ å’Œ WvÂ æ¥é€æ­¥å®ç°è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€‚
è¿™ä¸‰ä¸ªçŸ©é˜µç”¨äºå°†åµŒå…¥åçš„è¾“å…¥ token x(i)Â æ˜ å°„ä¸º**æŸ¥è¯¢å‘é‡**ã€**é”®å‘é‡**å’Œ**å€¼å‘é‡**ã€‚

![[file-20251220145415253.png]]

ä¹‹å‰ï¼šè®¡ç®—ä¸Šä¸‹æ–‡å‘é‡ï¼Œå°†ç¬¬äºŒä¸ªè¾“å…¥å…ƒç´  x(2)Â å®šä¹‰ä¸ºæŸ¥è¯¢ï¼ˆqueryï¼‰ï¼Œé€šè¿‡è®¡ç®—ç®€åŒ–çš„æ³¨æ„åŠ›æƒé‡æ¥å¾—åˆ°ä¸Šä¸‹æ–‡å‘é‡ z(2)

- åˆå§‹åŒ–ä¸‰ä¸ªæƒé‡çŸ©é˜µ
- è®¡ç®—Â queryã€key å’Œ value å‘é‡

![[file-20251220145847067.png]]

| **æ¦‚å¿µ**               | **æ€§è´¨** | **ä½œç”¨**            | **å˜åŒ–æ€§**          |
| -------------------- | ------ | ----------------- | ---------------- |
| **æƒé‡çŸ©é˜µ** ($W$)       | æ¨¡å‹å‚æ•°   | å°†è¾“å…¥è½¬æ¢ä¸º Q, K, V    | è®­ç»ƒå®Œæˆåå›ºå®šï¼Œä¸éšè¾“å…¥å˜åŒ–   |
| **æ³¨æ„åŠ›åˆ†æ•°** (Score)    | ä¸­é—´å˜é‡   | è®¡ç®— Q ä¸ K çš„åŸå§‹ç›¸å…³æ€§   | éšç€è¾“å…¥å†…å®¹çš„ä¸åŒè€Œå®æ—¶è®¡ç®—   |
| **æ³¨æ„åŠ›æƒé‡** ($\alpha$) | æ¦‚ç‡åˆ†å¸ƒ   | å†³å®šå¯¹ Vï¼ˆå€¼ï¼‰è¿›è¡ŒåŠ æƒæ±‚å’Œçš„æ¯”ä¾‹ | éšè¾“å…¥åŠ¨æ€å˜åŒ–ï¼Œæ˜¯æœ€ç»ˆçš„å…³æ³¨é‡ç‚¹ |

![[file-20251220150438869.png]]

æ³¨æ„åŠ›åˆ†æ•°ï¼šæŸ¥è¯¢å‘é‡å’Œé”®å‘é‡çš„ç‚¹ç§¯

æ³¨æ„åŠ›åˆ†æ•°ï¼ˆAttention Scoresï¼‰ç»è¿‡å½’ä¸€åŒ–ï¼ˆNormalizationï¼‰å¤„ç†åï¼Œå°±å˜æˆäº†**æ³¨æ„åŠ›æƒé‡ï¼ˆAttention Weightsï¼‰**ã€‚

é€šè¿‡ç¼©æ”¾æ³¨æ„åŠ›åˆ†æ•°å¹¶åº”ç”¨softmaxå‡½æ•°æ¥è®¡ç®—æ³¨æ„åŠ›æƒé‡ï¼Œé€šè¿‡å°†æ³¨æ„åŠ›å¾—åˆ†é™¤ä»¥`keys`åµŒå…¥ç»´åº¦çš„å¹³æ–¹æ ¹æ¥è¿›è¡Œç¼©æ”¾ã€‚

![[file-20251220152116899.png]]

> [!TIP]
> å¯¹åµŒå…¥ç»´åº¦å½’ä¸€åŒ–æ˜¯ä¸ºäº†é¿å…æ¢¯åº¦è¿‡å°ï¼Œä»è€Œæå‡è®­ç»ƒæ€§èƒ½ã€‚å½“ç»´åº¦å¾ˆå¤§ï¼Œä¸”ç‚¹ç§¯å¢å¤§æ—¶ï¼Œsoftmaxå‡½æ•°æ›´åƒè·ƒé˜¶å‡½æ•°ï¼Œå¯èƒ½å¯¼è‡´æ¢¯åº¦æ¥è¿‘äºé›¶ã€‚

è®¡ç®—ä¸Šä¸‹æ–‡å‘é‡ï¼Œå¯¹äºè¾“å…¥å‘é‡è¿›è¡ŒåŠ æƒæ±‚å’Œï¼Œé€šè¿‡å¯¹å€¼å‘é‡çš„åŠ æƒå’Œæ¥è®¡ç®—ä¸Šä¸‹æ–‡å‘é‡ã€‚è¿™é‡Œï¼Œæ³¨æ„åŠ›æƒé‡ä½œä¸ºåŠ æƒå› å­ï¼Œç”¨äºè¡¡é‡æ¯ä¸ªå€¼å‘é‡çš„é‡è¦æ€§ã€‚

![[file-20251220152313164.png]]
åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªè®¡ç®—äº†ä¸€ä¸ªä¸Šä¸‹æ–‡å‘é‡ z(2)

> [!TIP]
> åœ¨æ³¨æ„åŠ›æœºåˆ¶çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œâ€œé”®â€ï¼ˆkeyï¼‰ã€â€œæŸ¥è¯¢â€ï¼ˆqueryï¼‰å’Œâ€œå€¼â€ï¼ˆvalueï¼‰è¿™äº›æœ¯è¯­æ¥æºäºä¿¡æ¯æ£€ç´¢å’Œæ•°æ®åº“é¢†åŸŸï¼Œåœ¨è¿™äº›é¢†åŸŸä¸­ä¹Ÿä½¿ç”¨ç±»ä¼¼çš„æ¦‚å¿µæ¥å­˜å‚¨ã€æœç´¢å’Œæ£€ç´¢ä¿¡æ¯
> **æŸ¥è¯¢**ï¼ˆqueryï¼‰ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„æœç´¢æŸ¥è¯¢ã€‚å®ƒä»£è¡¨æ¨¡å‹å½“å‰å…³æ³¨æˆ–è¯•å›¾ç†è§£çš„é¡¹ï¼ˆå¦‚å¥å­ä¸­çš„æŸä¸ªè¯æˆ– tokenï¼‰ã€‚é€šè¿‡æŸ¥è¯¢ï¼Œæ¨¡å‹å¯ä»¥æ¢æŸ¥è¾“å…¥åºåˆ—ä¸­çš„å…¶ä»–éƒ¨åˆ†ï¼Œä»¥ç¡®å®šå¯¹å®ƒä»¬åº”å…³æ³¨çš„ç¨‹åº¦ã€‚
> **é”®**ï¼ˆkeyï¼‰ç±»ä¼¼äºæ•°æ®åº“ä¸­ç”¨äºç´¢å¼•å’ŒæŸ¥æ‰¾çš„é”®ã€‚åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­ï¼Œè¾“å…¥åºåˆ—çš„æ¯ä¸ªå…ƒç´ ï¼ˆä¾‹å¦‚å¥å­ä¸­çš„æ¯ä¸ªå•è¯ï¼‰éƒ½å¯¹åº”ä¸€ä¸ªå…³è”çš„â€˜é”®â€™ã€‚è¿™äº›â€˜é”®â€™ç”¨äºä¸â€˜æŸ¥è¯¢â€™è¿›è¡ŒåŒ¹é…ã€‚
> **å€¼**ï¼ˆvalueï¼‰ç±»ä¼¼äºæ•°æ®åº“ä¸­çš„é”®å€¼å¯¹ä¸­çš„â€œå€¼â€ã€‚å®ƒè¡¨ç¤ºè¾“å…¥é¡¹çš„å®é™…å†…å®¹æˆ–è¡¨ç¤ºã€‚å½“æ¨¡å‹ç¡®å®šå“ªäº›é”®ï¼ˆå³è¾“å…¥ä¸­çš„å“ªäº›éƒ¨åˆ†ï¼‰ä¸æŸ¥è¯¢ï¼ˆå½“å‰çš„å…³æ³¨é¡¹ï¼‰æœ€ç›¸å…³æ—¶ï¼Œå°±ä¼šæ£€ç´¢å‡ºå¯¹åº”çš„å€¼ã€‚

### 3.4.2 å®ç°ä¸€ä¸ªç®€æ´çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶Pythonç±»

![[file-20251220152827645.png]]

![[18.webp]]

åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œå°†å¯¹è‡ªæ³¨æ„åŠ›æœºåˆ¶è¿›è¡Œå¢å¼ºï¼Œé‡ç‚¹åŠ å…¥å› æœå’Œå¤šå¤´æœºåˆ¶ã€‚
- å› æœå±æ€§æ¶‰åŠå¯¹æ³¨æ„åŠ›æœºåˆ¶çš„ä¿®æ”¹ï¼Œé˜²æ­¢æ¨¡å‹è®¿é—®åºåˆ—ä¸­çš„åç»­ä¿¡æ¯ã€‚è¿™åœ¨è¯­è¨€å»ºæ¨¡ç­‰ä»»åŠ¡ä¸­è‡³å…³é‡è¦ï¼Œå› ä¸ºåœ¨è¿™äº›ä»»åŠ¡ä¸­ï¼Œæ¯ä¸ªè¯çš„é¢„æµ‹åªèƒ½ä¾èµ–ä¹‹å‰çš„è¯ã€‚
- å¤šå¤´ç»„ä»¶å°†æ³¨æ„åŠ›æœºåˆ¶åˆ†è§£ä¸ºå¤šä¸ªâ€˜å¤´â€™ã€‚æ¯ä¸ªå¤´èƒ½å¤Ÿå­¦ä¹ æ•°æ®çš„ä¸åŒæ–¹é¢ï¼Œä½¿æ¨¡å‹èƒ½å¤ŸåŒæ—¶å…³æ³¨æ¥è‡ªä¸åŒè¡¨ç¤ºå­ç©ºé—´çš„ä¸åŒä½ç½®çš„ä¿¡æ¯ã€‚è¿™æé«˜äº†æ¨¡å‹åœ¨å¤æ‚ä»»åŠ¡ä¸­çš„æ€§èƒ½ã€‚

## 3.5 ä½¿ç”¨å› æœæ³¨æ„åŠ›æœºåˆ¶æ¥å±è”½åç»­è¯

å› æœæ³¨æ„åŠ›ï¼ˆä¹Ÿç§°ä¸ºæ©è”½æ³¨æ„åŠ›ï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„è‡ªæ³¨æ„åŠ›å½¢å¼ã€‚å®ƒé™åˆ¶æ¨¡å‹åœ¨å¤„ç†ä»»ä½•ç»™å®šçš„ token æ—¶ï¼Œåªèƒ½è€ƒè™‘åºåˆ—ä¸­çš„å‰ä¸€ä¸ªå’Œå½“å‰è¾“å…¥ï¼Œè€Œä¸èƒ½çœ‹åˆ°åç»­çš„å†…å®¹ã€‚è¿™ä¸æ ‡å‡†çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶å½¢æˆå¯¹æ¯”ï¼Œåè€…å…è®¸æ¨¡å‹åŒæ—¶è®¿é—®æ•´ä¸ªè¾“å…¥åºåˆ—ã€‚
![[19.webp]]

### 3.5.1 åº”ç”¨å› æœæ³¨æ„åŠ›æ©ç 

![[file-20251220160752155.png]]

è®¡ç®—æ³¨æ„åŠ›æƒé‡çŸ©é˜µï¼Œå¹¶ç”Ÿæˆæ©ç çŸ©é˜µã€‚
![[file-20251220162101778.png]]

çŸ©é˜µç›¸ä¹˜åè¿›è¡Œå½’ä¸€åŒ–å¤„ç†ï¼š

![[file-20251220162140572.png]]

è¿›ä¸€æ­¥æ”¹è¿›ï¼Œåˆ©ç”¨softmaxï¼Œä»¥æ›´å°‘çš„æ­¥éª¤æç¬‘çš„è®¡ç®—æ©ç åçš„æ³¨æ„åŠ›æƒé‡ã€‚
Softmax å‡½æ•°å°†è¾“å…¥å€¼è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒã€‚å½“ä¸€è¡Œä¸­å­˜åœ¨è´Ÿæ— ç©·å€¼ï¼ˆ-âˆï¼‰æ—¶ï¼ŒSoftmax å‡½æ•°ä¼šå°†è¿™äº›å€¼è§†ä¸ºé›¶æ¦‚ç‡ã€‚ï¼ˆä»æ•°å­¦ä¸Šè®²ï¼Œè¿™æ˜¯å› ä¸º eâˆ’âˆÂ æ¥è¿‘äº 0ã€‚ï¼‰

![[file-20251220162413394.png]]

### 3.5.2 ä½¿ç”¨ dropout é®æ©é¢å¤–çš„æ³¨æ„åŠ›æƒé‡

Dropout åœ¨æ·±åº¦å­¦ä¹ ä¸­æ˜¯ä¸€ç§æŠ€æœ¯ï¼Œå³åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­éšæœºå¿½ç•¥ä¸€äº›éšè—å±‚å•å…ƒï¼Œå®é™…ä¸Šå°†å®ƒä»¬â€œä¸¢å¼ƒâ€ã€‚è¿™ç§æ–¹æ³•æœ‰åŠ©äºé˜²æ­¢è¿‡æ‹Ÿåˆï¼Œç¡®ä¿æ¨¡å‹ä¸ä¼šè¿‡äºä¾èµ–ä»»ä½•ç‰¹å®šçš„éšè—å±‚å•å…ƒç»„åˆã€‚éœ€è¦ç‰¹åˆ«å¼ºè°ƒçš„æ˜¯ï¼ŒDropout ä»…åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­ä½¿ç”¨ï¼Œè®­ç»ƒç»“æŸååˆ™ä¼šç¦ç”¨ã€‚

åœ¨ Transformer æ¶æ„ä¸­ï¼ˆåŒ…æ‹¬ GPT ç­‰æ¨¡å‹ï¼‰ï¼Œæ³¨æ„åŠ›æœºåˆ¶ä¸­çš„ Dropout é€šå¸¸åº”ç”¨äºä¸¤ä¸ªç‰¹å®šåŒºåŸŸï¼šè®¡ç®—æ³¨æ„åŠ›å¾—åˆ†ä¹‹åï¼Œæˆ–å°†æ³¨æ„åŠ›æƒé‡åº”ç”¨äº value å‘é‡ä¹‹åã€‚

![[22.webp | 500]]

ä½¿ç”¨äº†50%çš„ dropout ç‡ï¼Œå½“å¯¹æ³¨æ„åŠ›æƒé‡çŸ©é˜µåº”ç”¨ 50% çš„ dropout æ—¶ï¼ŒçŸ©é˜µä¸­ä¸€åŠçš„å…ƒç´ ä¼šè¢«éšæœºè®¾ç½®ä¸ºé›¶ã€‚ä¸ºäº†è¡¥å¿æœ‰æ•ˆå…ƒç´ çš„å‡å°‘ï¼ŒçŸ©é˜µä¸­å‰©ä½™å…ƒç´ çš„å€¼ä¼šè¢«æ”¾å¤§ 1/0.5 = 2 å€ã€‚è¿™ä¸ªç¼©æ”¾æ“ä½œè‡³å…³é‡è¦ï¼Œå¯ä»¥åœ¨è®­ç»ƒå’Œæ¨ç†é˜¶æ®µä¿æŒæ³¨æ„åŠ›æœºåˆ¶çš„æ•´ä½“æƒé‡å¹³è¡¡ï¼Œç¡®ä¿æ³¨æ„åŠ›æœºåˆ¶åœ¨è¿™ä¸¤ä¸ªé˜¶æ®µçš„å¹³å‡å½±å“ä¿æŒä¸€è‡´ã€‚

![[file-20251220163349403.png]]
### 3.5.3 å®ç°ä¸€ä¸ªç®€æ´çš„å› æœæ³¨æ„åŠ›ç±»

å°†æŠŠå› æœæ³¨æ„åŠ›å’Œ dropout çš„ä¿®æ”¹æ•´åˆåˆ°åœ¨ 3.4 èŠ‚å¼€å‘çš„Â `SelfAttention`Â Python ç±»ä¸­ã€‚è¯¥ç±»å°†ä½œä¸ºæ¨¡æ¿ï¼Œç”¨äºæ¥ä¸‹æ¥ä¸€èŠ‚ä¸­å¼€å‘å¤šå¤´æ³¨æ„åŠ›ï¼ˆå¤šå¤´æ³¨æ„åŠ›å°†æ˜¯æˆ‘ä»¬åœ¨æœ¬ç« å®ç°çš„æœ€åä¸€ä¸ªæ³¨æ„åŠ›ç±»ï¼‰ã€‚

![[file-20251220163618590.png]]

![[23.webp]]

## 3.6 ä»å•å¤´æ³¨æ„åŠ›æ‰©å±•åˆ°å¤šå¤´æ³¨æ„åŠ›

**â€˜å¤šå¤´â€™** ä¸€è¯æŒ‡çš„æ˜¯å°†æ³¨æ„åŠ›æœºåˆ¶åˆ’åˆ†ä¸ºå¤šä¸ªâ€˜å¤´â€™ï¼Œæ¯ä¸ªå¤´ç‹¬ç«‹è¿ä½œã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå•ä¸ªå› æœæ³¨æ„åŠ›æ¨¡å—å¯ä»¥è§†ä¸ºå•å¤´æ³¨æ„åŠ›ï¼Œå³åªæœ‰ä¸€ç»„æ³¨æ„åŠ›æƒé‡ç”¨äºæŒ‰é¡ºåºå¤„ç†è¾“å…¥ã€‚

- ç¬¬ 1 å°èŠ‚å°†é€šè¿‡å †å å¤šä¸ªå› æœæ³¨æ„åŠ›æ¨¡å—ï¼Œç›´è§‚åœ°æ„å»ºä¸€ä¸ªå¤šå¤´æ³¨æ„åŠ›æ¨¡å—ä»¥ä½œè¯´æ˜ã€‚
- ç¬¬ 2 å°èŠ‚å°†ä»¥ä¸€ç§æ›´å¤æ‚ä½†è®¡ç®—æ•ˆç‡æ›´é«˜çš„æ–¹å¼å®ç°ç›¸åŒçš„å¤šå¤´æ³¨æ„åŠ›æ¨¡å—ã€‚

### 3.6.1 å †å å¤šå±‚å•å¤´æ³¨æ„åŠ›å±‚

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå®ç°å¤šå¤´æ³¨æ„åŠ›éœ€è¦åˆ›å»ºå¤šä¸ªè‡ªæ³¨æ„åŠ›æœºåˆ¶çš„å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹éƒ½å…·æœ‰ç‹¬ç«‹çš„æƒé‡ï¼Œç„¶åå°†å®ƒä»¬çš„è¾“å‡ºåˆå¹¶ã€‚

![[24.webp]]

å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨å¹¶è¡Œè¿è¡Œå¤šä¸ªæ³¨æ„åŠ›æœºåˆ¶çš„è¿‡ç¨‹ä¸­ï¼Œå¯¹è¾“å…¥æ•°æ®ï¼ˆå¦‚æ³¨æ„åŠ›æœºåˆ¶ä¸­çš„ queryã€key å’Œ value å‘é‡ï¼‰ä½¿ç”¨ä¸åŒçš„ã€å¯å­¦ä¹ çš„çº¿æ€§æŠ•å½±ã€‚å…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å°†è¿™äº›è¾“å…¥æ•°æ®ä¸æƒé‡çŸ©é˜µç›¸ä¹˜ï¼Œå¾—åˆ°ä¸åŒçš„æŠ•å½±ç»“æœã€‚

![[25.webp]]
å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„å°è£…ç±»ï¼š

![[file-20251220164417846.png]]

å®ç°äº†ä¸€ä¸ªÂ `MultiHeadAttentionWrapper`ï¼Œç”¨äºç»„åˆå¤šä¸ªå•å¤´æ³¨æ„åŠ›æ¨¡å—ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨Â `forward`Â æ–¹æ³•ä¸­ï¼Œè¿™äº›æ¨¡å—æ˜¯é€šè¿‡Â `[head(x) for head in self.heads]`Â ä¸²è¡Œå¤„ç†çš„ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å¹¶è¡Œå¤„ç†å„ä¸ªæ³¨æ„åŠ›å¤´æ¥ä¼˜åŒ–è¯¥å®ç°ã€‚å®ç°è¿™ä¸€ç›®æ ‡çš„ä¸€ç§æ–¹æ³•æ˜¯ï¼Œé€šè¿‡çŸ©é˜µä¹˜æ³•åŒæ—¶è®¡ç®—æ‰€æœ‰æ³¨æ„åŠ›å¤´çš„è¾“å‡ºï¼Œå°†åœ¨ä¸‹ä¸€èŠ‚ä¸­è¯¦ç»†æ¢è®¨ã€‚

### 3.6.2 é€šè¿‡æƒé‡åˆ†å‰²å®ç°å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶

é«˜æ•ˆçš„å¤šå¤´æ³¨æ„åŠ›ç±»çš„å®ç°ï¼š

```python
class MultiHeadAttention(nn.Module):
    def __init__(self, d_in, d_out, context_length, dropout, num_heads, qkv_bias=False):
        super().__init__()
        assert (d_out % num_heads == 0), \
            "d_out must be divisible by num_heads"

        self.d_out = d_out
        self.num_heads = num_heads
        self.head_dim = d_out // num_heads # Reduce the projection dim to match desired output dim

        self.W_query = nn.Linear(d_in, d_out, bias=qkv_bias)
        self.W_key = nn.Linear(d_in, d_out, bias=qkv_bias)
        self.W_value = nn.Linear(d_in, d_out, bias=qkv_bias)
        self.out_proj = nn.Linear(d_out, d_out)  # Linear layer to combine head outputs
        self.dropout = nn.Dropout(dropout)
        self.register_buffer(
            "mask",
            torch.triu(torch.ones(context_length, context_length),
                       diagonal=1)
        )

    def forward(self, x):
        b, num_tokens, d_in = x.shape
        # As in `CausalAttention`, for inputs where `num_tokens` exceeds `context_length`, 
        # this will result in errors in the mask creation further below. 
        # In practice, this is not a problem since the LLM (chapters 4-7) ensures that inputs  
        # do not exceed `context_length` before reaching this forward method.

        keys = self.W_key(x) # Shape: (b, num_tokens, d_out)
        queries = self.W_query(x)
        values = self.W_value(x)

        # We implicitly split the matrix by adding a `num_heads` dimension
        # Unroll last dim: (b, num_tokens, d_out) -> (b, num_tokens, num_heads, head_dim)
        keys = keys.view(b, num_tokens, self.num_heads, self.head_dim) 
        values = values.view(b, num_tokens, self.num_heads, self.head_dim)
        queries = queries.view(b, num_tokens, self.num_heads, self.head_dim)

        # Transpose: (b, num_tokens, num_heads, head_dim) -> (b, num_heads, num_tokens, head_dim)
        keys = keys.transpose(1, 2)
        queries = queries.transpose(1, 2)
        values = values.transpose(1, 2)

        # Compute scaled dot-product attention (aka self-attention) with a causal mask
        attn_scores = queries @ keys.transpose(2, 3)  # Dot product for each head

        # Original mask truncated to the number of tokens and converted to boolean
        mask_bool = self.mask.bool()[:num_tokens, :num_tokens]

        # Use the mask to fill attention scores
        attn_scores.masked_fill_(mask_bool, -torch.inf)
        
        attn_weights = torch.softmax(attn_scores / keys.shape[-1]**0.5, dim=-1)
        attn_weights = self.dropout(attn_weights)

        # Shape: (b, num_tokens, num_heads, head_dim)
        context_vec = (attn_weights @ values).transpose(1, 2) 
        
        # Combine heads, where self.d_out = self.num_heads * self.head_dim
        context_vec = context_vec.contiguous().view(b, num_tokens, self.d_out)
        context_vec = self.out_proj(context_vec) # optional projection

        return context_vec

torch.manual_seed(123)

batch_size, context_length, d_in = batch.shape
d_out = 2
mha = MultiHeadAttention(d_in, d_out, context_length, 0.0, num_heads=2)

context_vecs = mha(batch)

print(context_vecs)
print("context_vecs.shape:", context_vecs.shape)
```

![[26.webp]]

å®ç°äº† MultiHeadAttention ç±»ï¼Œè¿™å°†åœ¨åç»­ç« èŠ‚å®ç°å’Œè®­ç»ƒ LLM æ—¶ä½¿ç”¨ã€‚è¯·æ³¨æ„ï¼Œè™½ç„¶ä»£ç åŠŸèƒ½é½å…¨ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨äº†è¾ƒå°çš„åµŒå…¥ç»´åº¦å’Œæ³¨æ„åŠ›å¤´æ•°ï¼Œä»¥ä¾¿è®©è¾“å‡ºç»“æœæ›´æ˜“äºé˜…è¯»ã€‚

ä½œä¸ºå¯¹æ¯”ï¼Œæœ€å°çš„ GPT-2 æ¨¡å‹ï¼ˆ1.17 äº¿å‚æ•°ï¼‰å…·æœ‰ 12 ä¸ªæ³¨æ„åŠ›å¤´å’Œ 768 çš„ä¸Šä¸‹æ–‡å‘é‡åµŒå…¥å¤§å°ã€‚è€Œæœ€å¤§çš„ GPT-2 æ¨¡å‹ï¼ˆ15 äº¿å‚æ•°ï¼‰åˆ™å…·æœ‰ 25 ä¸ªæ³¨æ„åŠ›å¤´å’Œ 1600 çš„ä¸Šä¸‹æ–‡å‘é‡åµŒå…¥å¤§å°ã€‚è¯·æ³¨æ„ï¼Œåœ¨ GPT æ¨¡å‹ä¸­ï¼Œtoken è¾“å…¥çš„åµŒå…¥å¤§å°ä¸ä¸Šä¸‹æ–‡åµŒå…¥å¤§å°æ˜¯ç›¸åŒçš„


> [!Question]
> Optional information to help a user be more successful.

<iframe
		src="http:www.bilibili.com/video/BV13z421U7cs/?spm_id_from=333.1387.collection.video_card.click&vd_source=7f2e56abe70052cbafa78cc2de71ac46EmbedVideoBilibili%"
		scrolling="no"
		border="0"
		frameborder="no"
		framespacing="0"
		allowfullscreen="true"
		style="height:100%;width:100%; aspect-ratio: 16 / 9;">
</iframe>

# 4. ä»é›¶å¼€å§‹å®ç°ä¸€ä¸ªç”¨äºæ–‡æœ¬ç”Ÿæˆçš„ GPT æ¨¡å‹

